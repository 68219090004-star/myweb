<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 800px;
            margin: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .login-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .login-card {
            flex: 1;
            min-width: 250px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }

        .login-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .attendance-section {
            display: none;
        }

        .student-list {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .student-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }

        .student-stats {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .attendance-buttons {
            display: flex;
            gap: 10px;
        }

        .attendance-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 60px;
        }

        .btn-present {
            background: #28a745;
            color: white;
        }

        .btn-present:hover {
            background: #218838;
        }

        .btn-leave {
            background: #ffc107;
            color: #333;
        }

        .btn-leave:hover {
            background: #e0a800;
        }

        .btn-absent {
            background: #dc3545;
            color: white;
        }

        .btn-absent:hover {
            background: #c82333;
        }

        .status-fail {
            color: #dc3545;
            font-weight: bold;
        }

        .status-warning {
            color: #ffc107;
            font-weight: bold;
        }

        .logout-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: #5a6268;
        }

        .user-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
        }

        .readonly-notice {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .login-section {
                flex-direction: column;
            }

            .student-item {
                flex-direction: column;
                gap: 15px;
            }

            .attendance-buttons {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <div class="login-card" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; padding: 20px;">
                <div style="background: #2196f3; color: white; padding: 12px; margin: -20px -20px 15px -20px; border-radius: 15px 15px 0 0;">
                    <h3 style="margin: 0; color: white; font-size: 1.1rem;">üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                </div>
                <button class="btn" onclick="showStudentLogin()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 10px 20px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>

            <div class="login-card" style="background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 30%); border: 2px solid #ff9800; padding: 20px;">
                <div style="background: #ff9800; color: white; padding: 12px; margin: -20px -20px 15px -20px; border-radius: 15px 15px 0 0;">
                    <h3 style="margin: 0; color: white; font-size: 1.1rem;">üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π</h3>
                </div>
                <button class="btn" onclick="showTeacherLogin()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 10px 20px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>

        <!-- Student Login Modal -->
        <div id="studentLoginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 400px;">
                <h3 style="text-align: center; margin-bottom: 20px; color: #333;">üë®‚Äçüéì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <div class="input-group">
                    <input type="text" id="studentIdModal" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" onkeypress="if(event.key==='Enter') studentLoginFromModal()">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="studentLoginFromModal()" style="flex: 1;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button class="btn" onclick="hideStudentLogin()" style="flex: 1; background: #6c757d;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- Teacher Login Modal -->
        <div id="teacherLoginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 400px;">
                <h3 style="text-align: center; margin-bottom: 20px; color: #333;">üë®‚Äçüè´ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π</h3>
                <div class="input-group">
                    <input type="password" id="teacherKey" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏π" onkeypress="if(event.key==='Enter') teacherLogin()">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="teacherLogin()" style="flex: 1;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button class="btn" onclick="hideTeacherLogin()" style="flex: 1; background: #6c757d;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- Attendance Section -->
        <div id="attendanceSection" class="attendance-section">
            <div class="user-info">
                <h3 id="userWelcome"></h3>
                <p id="userRole"></p>
            </div>

            <div id="readonlyNotice" class="readonly-notice" style="display: none;">
                üìñ ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
            </div>

            <div class="student-list">
                <h3 style="margin-bottom: 20px; color: #333;">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h3>
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <div class="input-group" style="flex: 1; min-width: 200px;">
                        <input type="date" id="attendanceDate" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
                    </div>
                    <div class="input-group" style="flex: 1; min-width: 200px;">
                        <select id="subjectSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</option>
                        </select>
                    </div>
                    <button class="btn" onclick="selectSubjectAndDate()" style="width: auto; padding: 12px 20px;">
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </button>
                </div>
                <div id="selectedInfo" style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
                    <strong id="selectedInfoText"></strong>
                </div>
            </div>

            <div id="addStudentSection" class="student-list" style="display: none;">
                <h3 style="margin-bottom: 20px; color: #333;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div class="input-group" style="flex: 1; min-width: 200px;">
                        <input type="text" id="newStudentId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 006)">
                    </div>
                    <div class="input-group" style="flex: 2; min-width: 250px;">
                        <input type="text" id="newStudentName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                    </div>
                    <button class="btn" onclick="addNewStudent()" style="width: auto; padding: 12px 20px;">
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </button>
                </div>
            </div>

            <div id="attendanceCheckSection" class="student-list" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h3 style="color: #333; margin: 0;">üìã ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="goBackToSelection()" style="width: auto; padding: 8px 15px; font-size: 0.9rem; background: #6c757d;">
                            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
                        </button>
                        <button id="toggleAddBtn" class="btn" onclick="toggleAddStudent()" style="width: auto; padding: 8px 15px; font-size: 0.9rem;">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                    </div>
                </div>
                <div id="studentsList"></div>
            </div>

            <div id="studentHistorySection" class="student-list" style="display: none;">
                <h3 style="margin-bottom: 20px; color: #333;">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                <div id="studentAttendanceHistory"></div>
            </div>

            <button class="logout-btn" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAuXlpSelhjTmOC9eCyjP-L_iJ7laOdLJ8",
            authDomain: "fbpofkbpof.firebaseapp.com",
            databaseURL: "https://fbpofkbpof-default-rtdb.firebaseio.com/",
            projectId: "fbpofkbpof",
            storageBucket: "fbpofkbpof.firebasestorage.app",
            messagingSenderId: "565215186792",
            appId: "1:565215186792:web:1646ab0757a6026ff990dd"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase functions available globally
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseRemove = remove;
    </script>

    <script>
        // Sample student data - with initial students
        let students = [
            { id: '001', name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', present: 0, leave: 0, absent: 0 },
            { id: '002', name: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', present: 0, leave: 0, absent: 0 },
            { id: '003', name: '‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å', present: 0, leave: 0, absent: 0 },
            { id: '004', name: '‡∏ô‡∏¥‡∏î‡∏≤ ‡∏Ç‡∏¢‡∏±‡∏ô‡∏î‡∏µ', present: 0, leave: 0, absent: 0 },
            { id: '005', name: '‡∏ò‡∏ô‡∏≤ ‡∏™‡∏∏‡∏Ç‡πÉ‡∏™', present: 0, leave: 0, absent: 0 }
        ];

        // Sample subjects
        let subjects = [
            { id: 'math', name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' },
            { id: 'thai', name: '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢' },
            { id: 'english', name: '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©' },
            { id: 'science', name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' },
            { id: 'social', name: '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤' }
        ];

        // Attendance records by date and subject
        let attendanceRecords = {};

        let currentUser = null;
        let currentStudentId = null;
        let isTeacher = false;
        let selectedSubject = null;
        let isFirebaseConnected = false;

        // Check if Firebase is properly configured
        function checkFirebaseConfig() {
            // Firebase is now properly configured with real values
            return true;
        }

        // Load data from Firebase
        async function loadDataFromFirebase() {
            if (!window.firebaseDB || !checkFirebaseConfig()) {
                console.log('Firebase not configured, using localStorage');
                loadDataFromLocalStorage();
                return;
            }

            try {
                // Load students
                const studentsRef = window.firebaseRef(window.firebaseDB, 'students');
                const studentsSnapshot = await window.firebaseGet(studentsRef);
                if (studentsSnapshot.exists()) {
                    const studentsData = studentsSnapshot.val();
                    students = Object.keys(studentsData).map(key => ({
                        ...studentsData[key],
                        firebaseKey: key
                    }));
                }

                // Load subjects
                const subjectsRef = window.firebaseRef(window.firebaseDB, 'subjects');
                const subjectsSnapshot = await window.firebaseGet(subjectsRef);
                if (subjectsSnapshot.exists()) {
                    const subjectsData = subjectsSnapshot.val();
                    subjects = Object.keys(subjectsData).map(key => ({
                        ...subjectsData[key],
                        firebaseKey: key
                    }));
                }

                // Load attendance records
                const recordsRef = window.firebaseRef(window.firebaseDB, 'attendanceRecords');
                const recordsSnapshot = await window.firebaseGet(recordsRef);
                if (recordsSnapshot.exists()) {
                    attendanceRecords = recordsSnapshot.val();
                }

                isFirebaseConnected = true;
                console.log('Data loaded from Firebase successfully');
                
                // Show Firebase status
                showFirebaseStatus(true);
                
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                loadDataFromLocalStorage();
                showFirebaseStatus(false);
            }
        }

        // Load data from localStorage (fallback)
        function loadDataFromLocalStorage() {
            const savedStudents = localStorage.getItem('attendanceData');
            if (savedStudents) {
                students = JSON.parse(savedStudents);
            }
            
            const savedSubjects = localStorage.getItem('subjectsData');
            if (savedSubjects) {
                subjects = JSON.parse(savedSubjects);
            }
            
            const savedRecords = localStorage.getItem('attendanceRecords');
            if (savedRecords) {
                attendanceRecords = JSON.parse(savedRecords);
            }
        }

        // Save data to Firebase
        async function saveDataToFirebase() {
            if (!window.firebaseDB || !isFirebaseConnected) {
                saveDataToLocalStorage();
                return;
            }

            try {
                // Save students
                const studentsRef = window.firebaseRef(window.firebaseDB, 'students');
                const studentsData = {};
                students.forEach(student => {
                    const key = student.firebaseKey || student.id;
                    studentsData[key] = {
                        id: student.id,
                        name: student.name,
                        present: student.present || 0,
                        leave: student.leave || 0,
                        absent: student.absent || 0
                    };
                });
                await window.firebaseSet(studentsRef, studentsData);

                // Save subjects
                const subjectsRef = window.firebaseRef(window.firebaseDB, 'subjects');
                const subjectsData = {};
                subjects.forEach(subject => {
                    const key = subject.firebaseKey || subject.id;
                    subjectsData[key] = {
                        id: subject.id,
                        name: subject.name
                    };
                });
                await window.firebaseSet(subjectsRef, subjectsData);

                // Save attendance records
                const recordsRef = window.firebaseRef(window.firebaseDB, 'attendanceRecords');
                await window.firebaseSet(recordsRef, attendanceRecords);

                console.log('Data saved to Firebase successfully');
                
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                saveDataToLocalStorage();
            }
        }

        // Save data to localStorage (fallback)
        function saveDataToLocalStorage() {
            localStorage.setItem('attendanceData', JSON.stringify(students));
            localStorage.setItem('subjectsData', JSON.stringify(subjects));
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
        }

        // Show Firebase connection status
        function showFirebaseStatus(connected) {
            // Remove existing status if any
            const existingStatus = document.getElementById('firebaseStatus');
            if (existingStatus) {
                existingStatus.remove();
            }

            const statusDiv = document.createElement('div');
            statusDiv.id = 'firebaseStatus';
            statusDiv.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                padding: 10px 15px;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: bold;
                z-index: 1001;
                ${connected ? 
                    'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : 
                    'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'
                }
            `;
            
            statusDiv.innerHTML = connected ? 
                'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : 
                'üî¥ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
            
            document.body.appendChild(statusDiv);
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                if (statusDiv) {
                    statusDiv.style.opacity = '0.7';
                }
            }, 3000);
        }

        // Load data (try Firebase first, fallback to localStorage)
        async function loadData() {
            await loadDataFromFirebase();
        }

        // Save data (try Firebase first, fallback to localStorage)
        async function saveData() {
            await saveDataToFirebase();
        }

        // Get today's date in YYYY-MM-DD format
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // Get Thai date format
        function getThaiDate(dateStr) {
            const date = new Date(dateStr);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            return date.toLocaleDateString('th-TH', options);
        }

        // Show student login modal
        function showStudentLogin() {
            const modal = document.getElementById('studentLoginModal');
            modal.style.display = 'flex';
        }

        // Hide student login modal
        function hideStudentLogin() {
            document.getElementById('studentLoginModal').style.display = 'none';
            document.getElementById('studentIdModal').value = '';
        }

        // Show teacher login modal
        function showTeacherLogin() {
            const modal = document.getElementById('teacherLoginModal');
            modal.style.display = 'flex';
        }

        // Hide teacher login modal
        function hideTeacherLogin() {
            document.getElementById('teacherLoginModal').style.display = 'none';
            document.getElementById('teacherKey').value = '';
        }

        // Teacher login
        function teacherLogin() {
            const key = document.getElementById('teacherKey').value;
            if (key === '123456') {
                currentUser = '‡∏Ñ‡∏£‡∏π';
                isTeacher = true;
                hideTeacherLogin();
                showAttendanceSection();
            } else {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
        }

        // Student login from modal
        function studentLoginFromModal() {
            const studentId = document.getElementById('studentIdModal').value.trim();
            if (!studentId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
                return;
            }

            // Check if student exists
            const student = students.find(s => s.id === studentId);
            if (!student) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏π');
                return;
            }

            currentUser = student.name;
            currentStudentId = studentId;
            isTeacher = false;
            hideStudentLogin();
            showAttendanceSection();
        }

        // Show attendance section
        function showAttendanceSection() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('attendanceSection').style.display = 'block';
            
            document.getElementById('userWelcome').textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${currentUser}`;
            document.getElementById('userRole').textContent = isTeacher ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Ñ‡∏£‡∏π (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ)' : '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)';
            
            if (!isTeacher) {
                document.getElementById('readonlyNotice').style.display = 'block';
                document.getElementById('studentHistorySection').style.display = 'block';
                document.querySelector('.student-list').style.display = 'none';
                renderStudentHistory();
            } else {
                document.getElementById('readonlyNotice').style.display = 'none';
                document.getElementById('studentHistorySection').style.display = 'none';
                document.querySelector('.student-list').style.display = 'block';
            }
            
            loadData();
            setupDateAndSubject();
        }

        // Setup date and subject selection
        function setupDateAndSubject() {
            // Set today's date as default
            document.getElementById('attendanceDate').value = getTodayDate();
            
            // Populate subjects dropdown
            const subjectSelect = document.getElementById('subjectSelect');
            subjectSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</option>';
            
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                subjectSelect.appendChild(option);
            });
        }

        // Select subject and date
        function selectSubjectAndDate() {
            const selectedDate = document.getElementById('attendanceDate').value;
            const selectedSubjectId = document.getElementById('subjectSelect').value;
            
            if (!selectedDate || !selectedSubjectId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤');
                return;
            }
            
            selectedSubject = subjects.find(s => s.id === selectedSubjectId);
            
            // Show selected info
            const selectedInfo = document.getElementById('selectedInfo');
            const selectedInfoText = document.getElementById('selectedInfoText');
            selectedInfoText.textContent = `üìÖ ${getThaiDate(selectedDate)} | üìö ${selectedSubject.name}`;
            selectedInfo.style.display = 'block';
            
            // Hide date/subject selection and show attendance section directly
            document.querySelector('.student-list').style.display = 'none';
            document.getElementById('attendanceCheckSection').style.display = 'block';
            
            renderStudentsList(selectedDate, selectedSubjectId);
        }

        // Go back to subject selection
        function goBackToSelection() {
            document.querySelector('.student-list').style.display = 'block';
            document.getElementById('attendanceCheckSection').style.display = 'none';
            document.getElementById('selectedInfo').style.display = 'none';
            document.getElementById('addStudentSection').style.display = 'none';
            
            // Reset form
            document.getElementById('attendanceDate').value = getTodayDate();
            document.getElementById('subjectSelect').value = '';
        }

        // Toggle add student section
        function toggleAddStudent() {
            const addSection = document.getElementById('addStudentSection');
            const toggleBtn = document.getElementById('toggleAddBtn');
            
            if (addSection.style.display === 'none') {
                addSection.style.display = 'block';
                toggleBtn.textContent = '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
            } else {
                addSection.style.display = 'none';
                toggleBtn.textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
                // Clear inputs
                document.getElementById('newStudentId').value = '';
                document.getElementById('newStudentName').value = '';
            }
        }

        // Initialize default data to Firebase
        async function initializeDefaultData() {
            if (!isFirebaseConnected) return;

            try {
                // Check if data already exists
                const studentsRef = window.firebaseRef(window.firebaseDB, 'students');
                const studentsSnapshot = await window.firebaseGet(studentsRef);
                
                if (!studentsSnapshot.exists()) {
                    // Add default students to Firebase
                    const defaultStudents = {
                        '001': { id: '001', name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', present: 0, leave: 0, absent: 0 },
                        '002': { id: '002', name: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', present: 0, leave: 0, absent: 0 },
                        '003': { id: '003', name: '‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å', present: 0, leave: 0, absent: 0 },
                        '004': { id: '004', name: '‡∏ô‡∏¥‡∏î‡∏≤ ‡∏Ç‡∏¢‡∏±‡∏ô‡∏î‡∏µ', present: 0, leave: 0, absent: 0 },
                        '005': { id: '005', name: '‡∏ò‡∏ô‡∏≤ ‡∏™‡∏∏‡∏Ç‡πÉ‡∏™', present: 0, leave: 0, absent: 0 }
                    };
                    await window.firebaseSet(studentsRef, defaultStudents);
                    console.log('Default students added to Firebase');
                }

                // Check if subjects exist
                const subjectsRef = window.firebaseRef(window.firebaseDB, 'subjects');
                const subjectsSnapshot = await window.firebaseGet(subjectsRef);
                
                if (!subjectsSnapshot.exists()) {
                    // Add default subjects to Firebase
                    const defaultSubjects = {
                        'math': { id: 'math', name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' },
                        'thai': { id: 'thai', name: '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢' },
                        'english': { id: 'english', name: '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©' },
                        'science': { id: 'science', name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' },
                        'social': { id: 'social', name: '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤' }
                    };
                    await window.firebaseSet(subjectsRef, defaultSubjects);
                    console.log('Default subjects added to Firebase');
                }

                // Reload data after initialization
                await loadDataFromFirebase();
                
            } catch (error) {
                console.error('Error initializing default data:', error);
            }
        }

        // Add new student
        async function addNewStudent() {
            if (!isTeacher) {
                alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
                return;
            }

            const studentId = document.getElementById('newStudentId').value.trim();
            const studentName = document.getElementById('newStudentName').value.trim();

            if (!studentId || !studentName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            // Check if student ID already exists
            if (students.find(s => s.id === studentId)) {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }

            // Add new student
            students.push({
                id: studentId,
                name: studentName,
                present: 0,
                leave: 0,
                absent: 0
            });

            await saveData();
            
            // Clear inputs and hide add section
            document.getElementById('newStudentId').value = '';
            document.getElementById('newStudentName').value = '';
            toggleAddStudent();
            
            // Re-render current attendance list if showing
            const selectedDate = document.getElementById('attendanceDate').value;
            const selectedSubjectId = document.getElementById('subjectSelect').value;
            if (selectedDate && selectedSubjectId && document.getElementById('attendanceCheckSection').style.display !== 'none') {
                renderStudentsList(selectedDate, selectedSubjectId);
            }
            
            alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${studentName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        }

        // Delete student
        async function deleteStudent(studentId) {
            if (!isTeacher) {
                alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
                return;
            }

            const student = students.find(s => s.id === studentId);
            if (!student) return;

            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${student.name} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                students = students.filter(s => s.id !== studentId);
                
                // Remove from attendance records
                Object.keys(attendanceRecords).forEach(recordKey => {
                    if (attendanceRecords[recordKey][studentId]) {
                        delete attendanceRecords[recordKey][studentId];
                    }
                });
                
                await saveData();
                
                // Re-render current attendance if showing
                const selectedDate = document.getElementById('attendanceDate').value;
                const selectedSubjectId = document.getElementById('subjectSelect').value;
                if (selectedDate && selectedSubjectId) {
                    renderStudentsList(selectedDate, selectedSubjectId);
                }
                
                alert('‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            }
        }

        // Render student's personal attendance history
        function renderStudentHistory() {
            const container = document.getElementById('studentAttendanceHistory');
            container.innerHTML = '';

            if (!currentStudentId) return;

            // Show detailed history by subject
            const subjectStats = {};
            Object.keys(attendanceRecords).forEach(recordKey => {
                const [date, subjectId] = recordKey.split('_');
                if (attendanceRecords[recordKey][currentStudentId]) {
                    if (!subjectStats[subjectId]) {
                        subjectStats[subjectId] = { present: 0, leave: 0, absent: 0, records: [] };
                    }
                    const status = attendanceRecords[recordKey][currentStudentId];
                    subjectStats[subjectId][status]++;
                    subjectStats[subjectId].records.push({ date, status });
                }
            });

            if (Object.keys(subjectStats).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin-top: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
                return;
            }

            Object.keys(subjectStats).forEach(subjectId => {
                const subject = subjects.find(s => s.id === subjectId);
                if (!subject) return;

                const stats = subjectStats[subjectId];
                const isFailed = stats.absent >= 4 || stats.leave >= 8;
                const isWarning = stats.absent >= 3 || stats.leave >= 6;
                
                let statusText = '';
                let statusColor = '#28a745';
                let bgColor = '#e8f5e8';
                
                if (isFailed) {
                    statusText = '‚ö†Ô∏è ‡∏ï‡∏¥‡∏î ‡∏Ç‡∏£.';
                    statusColor = '#dc3545';
                    bgColor = '#f8d7da';
                } else if (isWarning) {
                    statusText = '‚ö†Ô∏è ‡πÉ‡∏Å‡∏•‡πâ‡∏ï‡∏¥‡∏î ‡∏Ç‡∏£.';
                    statusColor = '#ffc107';
                    bgColor = '#fff3cd';
                } else {
                    statusText = '‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥';
                }

                const subjectDiv = document.createElement('div');
                subjectDiv.style.background = bgColor;
                subjectDiv.style.borderRadius = '15px';
                subjectDiv.style.padding = '20px';
                subjectDiv.style.marginBottom = '20px';
                subjectDiv.style.border = `2px solid ${statusColor}`;

                subjectDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h4 style="color: #333; margin: 0;">üìö ${subject.name}</h4>
                        <div style="font-size: 1.1rem; font-weight: bold; color: ${statusColor};">${statusText}</div>
                    </div>
                    <div style="display: flex; justify-content: space-around; text-align: center; flex-wrap: wrap; gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 10px; min-width: 80px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; color: #28a745; font-weight: bold;">${stats.present}</div>
                            <div style="color: #666; font-size: 0.9rem;">‡∏°‡∏≤</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; min-width: 80px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; color: #ffc107; font-weight: bold;">${stats.leave}</div>
                            <div style="color: #666; font-size: 0.9rem;">‡∏•‡∏≤</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; min-width: 80px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; color: #dc3545; font-weight: bold;">${stats.absent}</div>
                            <div style="color: #666; font-size: 0.9rem;">‡∏Ç‡∏≤‡∏î</div>
                        </div>
                    </div>
                `;

                container.appendChild(subjectDiv);
            });
        }

        // Render students list for attendance
        function renderStudentsList(date, subjectId) {
            const container = document.getElementById('studentsList');
            container.innerHTML = '';

            // Show add student button for teachers
            const toggleAddBtn = document.getElementById('toggleAddBtn');
            if (isTeacher && toggleAddBtn) {
                toggleAddBtn.style.display = 'inline-block';
            } else if (toggleAddBtn) {
                toggleAddBtn.style.display = 'none';
            }

            const recordKey = `${date}_${subjectId}`;

            students.forEach(student => {
                const subjectStats = calculateStudentStats(student.id, subjectId);
                const isFailed = subjectStats.absent >= 4 || subjectStats.leave >= 8;
                const isWarning = subjectStats.absent >= 3 || subjectStats.leave >= 6;
                
                // Check if already marked for this date and subject
                const alreadyMarked = attendanceRecords[recordKey] && attendanceRecords[recordKey][student.id];
                
                const studentDiv = document.createElement('div');
                studentDiv.className = 'student-item';
                
                let statusClass = '';
                let statusText = '';
                if (isFailed) {
                    statusClass = 'status-fail';
                    statusText = ' (‡∏ï‡∏¥‡∏î ‡∏Ç‡∏£.)';
                } else if (isWarning) {
                    statusClass = 'status-warning';
                    statusText = ' (‡πÉ‡∏Å‡∏•‡πâ‡∏ï‡∏¥‡∏î ‡∏Ç‡∏£.)';
                }

                let currentStatus = '';
                if (alreadyMarked) {
                    const statusMap = { present: '‡∏°‡∏≤', leave: '‡∏•‡∏≤', absent: '‡∏Ç‡∏≤‡∏î' };
                    currentStatus = ` | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${statusMap[alreadyMarked]}`;
                }

                studentDiv.innerHTML = `
                    <div class="student-info">
                        <div class="student-name ${statusClass}">${student.name}${statusText}</div>
                        <div class="student-stats">
                            ‡∏£‡∏´‡∏±‡∏™: ${student.id} | ‡∏°‡∏≤: ${subjectStats.present} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á | ‡∏•‡∏≤: ${subjectStats.leave} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á | ‡∏Ç‡∏≤‡∏î: ${subjectStats.absent} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á${currentStatus}
                        </div>
                    </div>
                    <div class="attendance-buttons">
                        <button class="attendance-btn btn-present" onclick="markAttendance('${student.id}', 'present', '${date}', '${subjectId}')" 
                                ${!isTeacher || alreadyMarked ? 'disabled' : ''}>
                            ‡∏°‡∏≤
                        </button>
                        <button class="attendance-btn btn-leave" onclick="markAttendance('${student.id}', 'leave', '${date}', '${subjectId}')" 
                                ${!isTeacher || alreadyMarked ? 'disabled' : ''}>
                            ‡∏•‡∏≤
                        </button>
                        <button class="attendance-btn btn-absent" onclick="markAttendance('${student.id}', 'absent', '${date}', '${subjectId}')" 
                                ${!isTeacher || alreadyMarked ? 'disabled' : ''}>
                            ‡∏Ç‡∏≤‡∏î
                        </button>
                        ${isTeacher ? `<button class="attendance-btn" onclick="deleteStudent('${student.id}')" style="background: #dc3545; color: white; margin-left: 10px;">‡∏•‡∏ö</button>` : ''}
                    </div>
                `;

                container.appendChild(studentDiv);
            });
        }

        // Calculate stats for a student in a specific subject
        function calculateStudentStats(studentId, subjectId = null) {
            let present = 0, leave = 0, absent = 0;
            
            Object.keys(attendanceRecords).forEach(recordKey => {
                const [date, recordSubjectId] = recordKey.split('_');
                
                // If subjectId is specified, only count records for that subject
                if (subjectId && recordSubjectId !== subjectId) {
                    return;
                }
                
                if (attendanceRecords[recordKey][studentId]) {
                    const status = attendanceRecords[recordKey][studentId];
                    if (status === 'present') present++;
                    else if (status === 'leave') leave++;
                    else if (status === 'absent') absent++;
                }
            });
            
            return { present, leave, absent };
        }

        // Mark attendance
        async function markAttendance(studentId, type, date, subjectId) {
            if (!isTeacher) {
                alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                return;
            }

            const recordKey = `${date}_${subjectId}`;
            
            // Initialize record if not exists
            if (!attendanceRecords[recordKey]) {
                attendanceRecords[recordKey] = {};
            }
            
            // Check if already marked
            if (attendanceRecords[recordKey][studentId]) {
                alert('‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ');
                return;
            }
            
            // Mark attendance
            attendanceRecords[recordKey][studentId] = type;
            
            const student = students.find(s => s.id === studentId);
            if (student) {
                await saveData();
                renderStudentsList(date, subjectId);
                
                // Check if student failed in this subject
                const subjectStats = calculateStudentStats(studentId, subjectId);
                const currentSubject = subjects.find(s => s.id === subjectId);
                if (subjectStats.absent >= 4 || subjectStats.leave >= 8) {
                    alert(`${student.name} ‡∏ï‡∏¥‡∏î ‡∏Ç‡∏£. ‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤${currentSubject.name}‡πÅ‡∏•‡πâ‡∏ß!`);
                } else if (subjectStats.absent >= 3 || subjectStats.leave >= 6) {
                    alert(`${student.name} ‡πÉ‡∏Å‡∏•‡πâ‡∏ï‡∏¥‡∏î ‡∏Ç‡∏£. ‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤${currentSubject.name}‡πÅ‡∏•‡πâ‡∏ß!`);
                }
            }
        }

        // Logout
        function logout() {
            currentUser = null;
            currentStudentId = null;
            isTeacher = false;
            selectedSubject = null;
            
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('attendanceSection').style.display = 'none';
            document.getElementById('attendanceCheckSection').style.display = 'none';
            document.getElementById('studentHistorySection').style.display = 'none';
            document.getElementById('readonlyNotice').style.display = 'none';
            document.getElementById('selectedInfo').style.display = 'none';
            document.getElementById('addStudentSection').style.display = 'none';
            document.querySelector('.student-list').style.display = 'block';
            
            // Clear input fields
            document.getElementById('teacherKey').value = '';
            document.getElementById('studentIdModal').value = '';
            document.getElementById('attendanceDate').value = '';
            document.getElementById('subjectSelect').value = '';
        }

        // Initialize
        async function initialize() {
            await loadData();
            if (isFirebaseConnected) {
                await initializeDefaultData();
            }
        }
        
        initialize();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'981c0d10764926e6',t:'MTc1ODMxNjAyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
