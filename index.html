<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ระบบเช็คชื่อนักเรียน</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0;}
  header { background:#4CAF50; color:#fff; padding:10px; text-align:center;}
  main { padding:20px; max-width:800px; margin: auto;}
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center;}
  th { background:#eee; }
  button { padding:5px 10px; margin:2px; }
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
           background:rgba(0,0,0,0.5); justify-content:center; align-items:center;}
  .modal-content { background:#fff; padding:20px; border-radius:8px; min-width:300px; }
  .flex { display:flex; justify-content:space-between; align-items:center; }
  .hidden { display:none; }
  input { padding:5px; margin:5px 0; width:100%; }
  @media(max-width:600px){ table, th, td { font-size:12px; } button { padding:3px 5px; } }
</style>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<header>
  <h1>ระบบเช็คชื่อนักเรียน</h1>
</header>
<main>
  <div id="loginModal" class="modal flex">
    <div class="modal-content">
      <h2>เข้าสู่ระบบ</h2>
      <input type="text" id="username" placeholder="ชื่อผู้ใช้">
      <input type="password" id="password" placeholder="รหัสผ่าน">
      <button id="loginBtn">เข้าสู่ระบบ</button>
    </div>
  </div>

  <div id="teacherSection" class="hidden">
    <div class="flex">
      <h2>นักเรียน</h2>
      <button id="addStudentBtn">เพิ่มนักเรียน</button>
      <button id="logoutBtn">ออกจากระบบ</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>ชื่อ</th>
          <th>เช็คชื่อ</th>
          <th>แก้ไข</th>
          <th>ลบ</th>
        </tr>
      </thead>
      <tbody id="studentsList"></tbody>
    </table>
    <div id="addStudentForm" class="hidden">
      <h3>เพิ่มนักเรียนใหม่</h3>
      <input type="text" id="newStudentName" placeholder="ชื่อเต็ม">
      <button id="saveStudentBtn">บันทึก</button>
      <button id="cancelAddStudentBtn">ยกเลิก</button>
    </div>
  </div>

  <div id="studentSection" class="hidden">
    <h2>สวัสดีนักเรียน</h2>
    <table>
      <thead>
        <tr><th>วัน</th><th>วิชา</th><th>สถานะ</th></tr>
      </thead>
      <tbody id="studentRecords"></tbody>
    </table>
    <button id="logoutStudentBtn">ออกจากระบบ</button>
  </div>
</main>

  <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAuXlpSelhjTmOC9eCyjP-L_iJ7laOdLJ8",
            authDomain: "fbpofkbpof.firebaseapp.com",
            databaseURL: "https://fbpofkbpof-default-rtdb.firebaseio.com/",
            projectId: "fbpofkbpof",
            storageBucket: "fbpofkbpof.firebasestorage.app",
            messagingSenderId: "565215186792",
            appId: "1:565215186792:web:1646ab0757a6026ff990dd",
            measurementId: "G-41TZ8YDF52"
        
  };
  let firebaseAvailable = true;
  try {
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();
  } catch(e){ firebaseAvailable = false; }

  // ================== Data ==================
  let students = [];
  let attendanceRecords = {}; // key: date_studentId
  let currentUser = null;
  const teacherPassword = "123456";

  // ================== Helper ==================
  function saveData(){
    if(firebaseAvailable){
      db.ref('students').set(students);
      db.ref('attendance').set(attendanceRecords);
    } else {
      localStorage.setItem('students', JSON.stringify(students));
      localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
    }
  }

  function loadData(){
    if(firebaseAvailable){
      db.ref('students').once('value').then(snap=>{ students = snap.val() || []; renderStudentsList(); });
      db.ref('attendance').once('value').then(snap=>{ attendanceRecords = snap.val() || {}; if(currentUser && !currentUser.isTeacher) renderStudentRecords(); });
    } else {
      students = JSON.parse(localStorage.getItem('students')||'[]');
      attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')||'{}');
    }
  }

  function renderStudentsList(){
    const tbody = document.getElementById('studentsList');
    tbody.innerHTML = '';
    students.forEach((s,index)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${s.name}</td>
                      <td><button onclick="markAttendance(${index})">เช็คชื่อ</button></td>
                      <td><button onclick="editStudent(${index})">แก้ไข</button></td>
                      <td><button onclick="deleteStudent(${index})">ลบ</button></td>`;
      tbody.appendChild(tr);
    });
  }

  function renderStudentRecords(){
    const tbody = document.getElementById('studentRecords');
    tbody.innerHTML = '';
    const today = new Date().toLocaleDateString('th-TH');
    students.forEach((s)=>{
      if(s.name === currentUser.name){
        Object.keys(attendanceRecords).forEach(key=>{
          if(key.includes(s.name)){
            const rec = attendanceRecords[key];
            tbody.innerHTML += `<tr><td>${rec.date}</td><td>${rec.subject||'ทั่วไป'}</td><td>${rec.status}</td></tr>`;
          }
        });
      }
    });
  }

  // ================== CRUD ==================
  function markAttendance(index){
    const student = students[index];
    const date = new Date().toLocaleDateString('th-TH');
    const key = `${date}_${student.name}`;
    attendanceRecords[key] = { date: date, subject: 'ทั่วไป', status: 'มา' };
    saveData(); renderStudentsList();
  }

  function editStudent(index){
    const newName = prompt('แก้ไขชื่อ', students[index].name);
    if(newName){ students[index].name = newName; saveData(); renderStudentsList(); }
  }

  function deleteStudent(index){
    if(confirm('ต้องการลบใช่หรือไม่?')){
      const removed = students.splice(index,1);
      Object.keys(attendanceRecords).forEach(key=>{
        if(key.includes(removed[0].name)) delete attendanceRecords[key];
      });
      saveData(); renderStudentsList();
    }
  }

  function addStudent(name){
    if(!name) return alert('กรุณาใส่ชื่อ');
    students.push({name}); saveData(); renderStudentsList();
  }

  // ================== UI ==================
  document.getElementById('loginBtn').onclick = ()=>{
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    if(password===teacherPassword){
      currentUser = {name: username, isTeacher:true};
      document.getElementById('loginModal').style.display='none';
      document.getElementById('teacherSection').classList.remove('hidden');
      loadData();
    } else {
      // student login
      const found = students.find(s=>s.name===username);
      if(found){
        currentUser = {name: username, isTeacher:false};
        document.getElementById('loginModal').style.display='none';
        document.getElementById('studentSection').classList.remove('hidden');
        loadData(); renderStudentRecords();
      } else alert('ไม่พบผู้ใช้');
    }
  }

  document.getElementById('logoutBtn').onclick = ()=>{
    currentUser=null;
    document.getElementById('teacherSection').classList.add('hidden');
    document.getElementById('loginModal').style.display='flex';
  }
  document.getElementById('logoutStudentBtn').onclick = ()=>{
    currentUser=null;
    document.getElementById('studentSection').classList.add('hidden');
    document.getElementById('loginModal').style.display='flex';
  }

  document.getElementById('addStudentBtn').onclick = ()=>{
    document.getElementById('addStudentForm').classList.remove('hidden');
  }
  document.getElementById('cancelAddStudentBtn').onclick = ()=>{
    document.getElementById('addStudentForm').classList.add('hidden');
  }
  document.getElementById('saveStudentBtn').onclick = ()=>{
    const name = document.getElementById('newStudentName').value;
    addStudent(name);
    document.getElementById('newStudentName').value='';
    document.getElementById('addStudentForm').classList.add('hidden');
  }

  // ================== Init ==================
  document.getElementById('loginModal').style.display='flex';
  if(!firebaseAvailable){ loadData(); }
</script>
</body>
</html>
